<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ifms.adm.bbs.rcs.mapper.AdmRcsMapper">

	<!-- 자료실 목록 총건수 -->
	<select id="selectRcsTotalCount" parameterType="map" resultType="int">
		SELECT COUNT(*)
		FROM SZMS.PT_RECSROOM_M 
		WHERE 1 = 1
			AND DEL_YN = 'N'
			<if test="sysClsfCd != ''">  
	  		  	AND SYS_CLSF_CD = #{sysClsfCd}
  		  	</if>
			<if test="searchCondition == 'TTL'">
				AND RPSTR_TTL LIKE '%' || #{searchKeyword} || '%'
			</if>
			<if test="searchCondition == 'CN'">
				AND RPSTR_CN LIKE '%' || #{searchKeyword} || '%'
			</if>
			<if test="searchCondition == ''">
				AND ((RPSTR_TTL LIKE '%' || #{searchKeyword} || '%')
					OR (RPSTR_CN LIKE '%' || #{searchKeyword} || '%'))
			</if>
	</select>
	
	<!-- 자료실 관리 목록 조회 -->
	<select id="selectAdmRcsList" parameterType="map" resultType="egovMap">
		SELECT ROW_NUMBER() OVER (ORDER BY RPSTR_SN) AS ROW_NUM
			, RPSTR_SN
			, RPSTR_TTL 
			, RPSTR_CN 
			, INQ_CNT 
			, SYS_CLSF_CD 
			, CASE WHEN FILE_GROUP_SN > 0 THEN FILE_GROUP_SN
				ELSE 0
				END AS FILE_GROUP_SN 
			, TO_CHAR(FRST_REG_DT , 'YYYY-MM-DD') AS FRST_REG_DT
		FROM SZMS.PT_RECSROOM_M 
		WHERE 1 = 1
			AND DEL_YN = 'N'
			<if test="sysClsfCd != ''">  
	  		  	AND SYS_CLSF_CD = #{sysClsfCd}
  		  	</if>
			<if test="searchCondition == 'TTL'">
				AND RPSTR_TTL LIKE '%' || #{searchKeyword} || '%'
			</if>
			<if test="searchCondition == 'CN'">
				AND RPSTR_CN LIKE '%' || #{searchKeyword} || '%'
			</if>
			<if test="searchCondition == ''">
				AND ((RPSTR_TTL LIKE '%' || #{searchKeyword} || '%')
					OR (RPSTR_CN LIKE '%' || #{searchKeyword} || '%'))
			</if>
		ORDER BY RPSTR_SN DESC
		OFFSET #{startNo} ROWS FETCH NEXT #{listCount} ROWS ONLY
	</select>
	
	<!-- 자료실 등록 -->
	<insert id="insertRcs" parameterType="map">
		INSERT INTO SZMS.PT_RECSROOM_M (
			RPSTR_SN
			, RPSTR_TTL
			, RPSTR_CN
			, INQ_CNT
			, FILE_GROUP_SN
			, FRST_REG_DT
			, FRST_RGTR_ID
			, SYS_CLSF_CD
		)
		VALUES( 
			NEXTVAL('SZMS.SQ_PT_RECSROOM_M')
			, #{rpstrTtl}
			, #{rpstrCn}
			, 1
			, CAST(#{fileGroupSn} AS NUMERIC)
			, CURRENT_TIMESTAMP
			, #{frstRgtrId}
			, #{sysClsfCd}
		)
	</insert>
	
	<!-- 자료실 상세 조회 -->
	<select id="selectRcsDetail" parameterType="map" resultType="egovMap">
		SELECT RPSTR_SN
			, RPSTR_TTL 
			, RPSTR_CN 
			, INQ_CNT 
			, SYS_CLSF_CD 
			, CASE WHEN FILE_GROUP_SN IS NOT NULL THEN FILE_GROUP_SN
				ELSE 0
				END AS FILE_GROUP_SN
			, TO_CHAR(FRST_REG_DT , 'YYYY-MM-DD') AS FRST_REG_DT
			, CASE WHEN LAST_MDFCN_DT IS NOT NULL THEN TO_CHAR(LAST_MDFCN_DT , 'YYYY-MM-DD') 
				ELSE '-' 
				END AS LAST_MDFCN_DT
		FROM SZMS.PT_RECSROOM_M 
		WHERE 1 = 1
			AND RPSTR_SN = CAST(#{rpstrSn} AS NUMERIC)
	</select>
	
	<!-- 조회수 증가 -->
	<update id="updateInqCnt" parameterType="map">
		UPDATE SZMS.PT_RECSROOM_M
		SET INQ_CNT = INQ_CNT + 1
		WHERE RPSTR_SN = CAST(#{rpstrSn} AS NUMERIC)
	</update>
	
	<!-- 자료실 삭제 -->
	<delete id="deleteRcs" parameterType="map">
		UPDATE SZMS.PT_RECSROOM_M
		SET DEL_YN = 'Y'
			, LAST_MDFR_ID = #{userId}
			, LAST_MDFCN_DT = CURRENT_TIMESTAMP
		WHERE RPSTR_SN = CAST(#{rpstrSn} AS NUMERIC)
		<!-- DELETE FROM SZMS.PT_RECSROOM_M
		WHERE RPSTR_SN = CAST(#{rpstrSn} AS NUMERIC) -->
	</delete>
	
	<!-- 자료실 수정 -->
	<update id="updateRcs" parameterType="map">
		UPDATE SZMS.PT_RECSROOM_M
		SET RPSTR_TTL = #{rpstrTtl}
			, RPSTR_CN = #{rpstrCn}
			, LAST_MDFR_ID = #{lastMdfrId}
			, LAST_MDFCN_DT = CURRENT_TIMESTAMP
			, FILE_GROUP_SN = CAST(#{fileGroupSn} AS NUMERIC)
		WHERE RPSTR_SN = CAST(#{rpstrSn} AS NUMERIC)
	</update>
	
	<!-- 동영상 정보 -->
	<select id="selectVideoFile" parameterType="map" resultType="egovMap">
		SELECT R.RPSTR_SN 
  		 	, R.FILE_GROUP_SN 
  		 	, F.FILE_DTL_SN 
  		 	, F.ATCH_FILE_SZ 
  		 	, F.ORGNL_FILE_NM 
  		 	, F.SRVR_FILE_NM
  		 	, F.ORGNL_FILE_EXTN_NM 
  		 FROM SZMS.PT_RECSROOM_M R
  		 JOIN SZMS.PT_COM_AHFL_M F
  		 ON R.FILE_GROUP_SN = F.FILE_GROUP_SN 
  		 WHERE F.ORGNL_FILE_EXTN_NM = 'mp4'
  		 	AND R.RPSTR_SN = CAST(#{rpstrSn} AS NUMERIC)
  		 	AND F.DEL_YN = 'N'
  		 ORDER BY F.FILE_DTL_SN
  		 LIMIT 1
	</select>
	
</mapper>