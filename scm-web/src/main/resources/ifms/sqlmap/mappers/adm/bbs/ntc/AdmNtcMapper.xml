<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ifms.adm.bbs.ntc.mapper.AdmNtcMapper">

	<!-- 공지사항 목록 조회 -->
	<select id="selectAdmNtcList" resultType="egovMap" parameterType="map">
		SELECT ROW_NUMBER() OVER (ORDER BY HGHRK_NTC_YN, FRST_REG_DT) AS ROW_NUM
			 , NTC_MTTR_SN
			 , NTC_MTTR_TTL
			 , NTC_MTTR_CN
			 , NTC_MTTR_PSTG_YN
			 , HGHRK_NTC_YN
			 , INQ_CNT
			 , TO_CHAR(FRST_REG_DT, 'YYYY-MM-DD') AS FRST_REG_DT
			 , FRST_RGTR_ID               		 
			 , TO_CHAR(LAST_MDFCN_DT, 'YYYY-MM-DD') AS LAST_MDFCN_DT
			 , LAST_MDFR_ID
			 , CASE WHEN FILE_GROUP_SN > 0 THEN FILE_GROUP_SN
			 	ELSE  0
			 	END AS FILE_GROUP_SN 
			 , SYS_CLSF_CD
		FROM SZMS.PT_NTC_MTTR_M
		WHERE 1 = 1
  		  	AND DEL_YN = 'N'
  		  	<if test="sysClsfCd != ''">  
	  		  	AND SYS_CLSF_CD = #{sysClsfCd}
  		  	</if>
  		  	<if test="searchCondition == 'TTL'">  
  		  		AND NTC_MTTR_TTL LIKE '%' || #{searchKeyword} || '%' 
  		  	</if>
  		  	<if test="searchCondition == 'CN'">  
  		  		AND NTC_MTTR_CN LIKE '%' || #{searchKeyword} || '%' 
  		  	</if>
  		  	<if test="searchCondition == ''">  
  		  		AND ((NTC_MTTR_TTL LIKE '%' || #{searchKeyword} || '%')
  		  			OR 
  		  			(NTC_MTTR_CN LIKE '%' || #{searchKeyword} || '%'))
  		  	</if>
 		 ORDER BY ROW_NUM DESC
  		 OFFSET #{startNo} ROWS FETCH NEXT #{listCount} ROWS ONLY
	</select>

	<!-- 신규 공지사항 일련번호 채번 -->
	<select id="selectNextNtcMttrSn" resultType="int">
		SELECT NEXTVAL('SZMS.sq_pt_ntc_mttr_m') AS ntcMttrSn;
	</select>
	

	<!-- 공지사항 총 건수 -->
	<select id="selectAdminNtcListCnt" resultType="int" parameterType="map">
		/* AdminNtcMapper.selectAdminNtcListCnt */
		SELECT COUNT(*)
		  FROM SZMS.PT_NTC_MTTR_M A
		  WHERE 1 = 1
			AND A.DEL_YN = 'N'
			AND A.SYS_CLSF_CD = #{sysClsfCd}
			<if test="searchCondition == 'TTL'">
				AND A.NTC_MTTR_TTL LIKE '%' || #{searchKeyword} || '%'
			</if>
			<if test="searchCondition == 'CN'">
				AND A.NTC_MTTR_CN LIKE '%' || #{searchKeyword} || '%'
			</if>
			<if test="searchCondition == ''">
				AND ((A.NTC_MTTR_TTL LIKE '%' || #{searchKeyword} || '%')
				OR
				(A.NTC_MTTR_CN LIKE '%' || #{searchKeyword} || '%'))
			</if>
	</select>

	<!-- 공지사항 상세조회 -->
	<select id="selectAdminNtcDetail" parameterType="map" resultType="egovMap">
		SELECT NTC_MTTR_SN
			 , NTC_MTTR_TTL
			 , NTC_MTTR_CN
			 , NTC_MTTR_PSTG_YN
			 , HGHRK_NTC_YN
			 , INQ_CNT                 	 
			 , TO_CHAR(FRST_REG_DT, 'YYYY-MM-DD') AS FRST_REG_DT
			 , TO_CHAR(LAST_MDFCN_DT, 'YYYY-MM-DD') AS LAST_MDFCN_DT
			 , CASE WHEN FILE_GROUP_SN > 0 THEN FILE_GROUP_SN
			 	ELSE  0
			 	END AS FILE_GROUP_SN
			 , SYS_CLSF_CD 
		FROM SZMS.PT_NTC_MTTR_M N
		WHERE NTC_MTTR_SN = CAST(#{ntcMttrSn} AS NUMERIC)
	</select>
	
	
	<!-- 공지사항 조회수 -->
	<update id="addNtcInqCnt" parameterType="map">
		UPDATE SZMS.PT_NTC_MTTR_M
		SET INQ_CNT = CASE WHEN INQ_CNT IS NULL THEN 1 ELSE (INQ_CNT + 1) END
		WHERE NTC_MTTR_SN = CAST(#{ntcMttrSn} AS NUMERIC)
	</update>
	
	
	<!-- 공지사항 수정 -->
	<update id="updateNtc" parameterType="map">
		UPDATE SZMS.PT_NTC_MTTR_M
		SET NTC_MTTR_TTL = #{ntcMttrTtl}
			, NTC_MTTR_CN = #{ntcMttrCn}
			, NTC_MTTR_PSTG_YN = #{ntcMttrPstgYn}
			, HGHRK_NTC_YN = #{hghrkNtcYn}
			, LAST_MDFCN_DT = CURRENT_TIMESTAMP
			, LAST_MDFR_ID = #{lastMdfrId}
			, FILE_GROUP_SN = CAST(#{fileGroupSn} AS NUMERIC)
		WHERE NTC_MTTR_SN = CAST(#{ntcMttrSn} AS NUMERIC)
	</update>
	
	<!-- 공지사항 등록 -->
	<insert id="insertNtc" parameterType="map">
		insert into SZMS.PT_NTC_MTTR_M(
			NTC_MTTR_SN
			, NTC_MTTR_TTL
			, NTC_MTTR_CN
			, NTC_MTTR_PSTG_YN 
			, HGHRK_NTC_YN
			, FRST_REG_DT
			, FRST_RGTR_ID 
			, INQ_CNT
			, FILE_GROUP_SN
			, SYS_CLSF_CD
		)
		values (
			#{ntcMttrSn}
			, #{ntcMttrTtl}
			, #{ntcMttrCn}
			, #{ntcMttrPstgYn}
			, #{hghrkNtcYn}
			, CURRENT_TIMESTAMP
			, #{frstRgtrId}
			, 1
			, CAST(#{admNtcGroupSn.fileGroupSn} AS NUMERIC)
			, #{sysClsfCd}
		)
		
	</insert>
	
	
	<update id="deleteNtc" parameterType="map">
		UPDATE SZMS.PT_NTC_MTTR_M
		SET DEL_YN = 'Y'
			, LAST_MDFCN_DT = CURRENT_TIMESTAMP
			, LAST_MDFR_ID = #{lastMdfrId}
		WHERE NTC_MTTR_SN = #{ntcMttrSn}
	</update>
	
</mapper>